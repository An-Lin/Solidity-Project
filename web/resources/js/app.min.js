var App=function(){function e(e){r&&console.log(e)}function t(e){e===web3.eth.accounts[0]?(n.win(),a.setMode(a.modes().ENDGAME)):"0x0000000000000000000000000000000000000000"===e&&(n.loss(),a.setMode(a.modes().ENDGAME))}var n=function(){"use strict";function e(){t=$("#nonce"),n=$("#username"),a=$("#play-button")}var t,n,a;return{init:function(){e(),this.clear()},clear:function(){t.val("")},validPassword:function(){return t.val().length>=3||(alert("Please choose a password!"),!1)},getPassword:function(){return t.val()},validUsername:function(){return n.val().length>=3||(alert("Please choose a username!"),!1)},getUsername:function(){return n.val()},getAmount:function(){return"0.1"},userCanPlay:function(){return this.validPassword()&&this.validUsername()},attachPlayButtonClickListener:function(e){a.click(e)},getUserChoice:function(){return $("#rps-choice input:radio:checked").val()},triggerModal:function(){$("#gameResultModal").modal("show")},win:function(){alert("You Won!")},loss:function(){alert("You Lost.. Better luck next time.")}}}(),a=function(){"use strict";function e(){setTimeout(function(){App.checkForPlayerJoined()&&App.checkForPlayerReveal()||e()},20*t)}const t=1e3;var o=0;return{modes:function(){return{IDLE:0,WAITING:1,REVEAL:2,WAITING_REVEAL:3,ENDGAME:4}},getMode:function(){return o},setMode:function(t){switch(o=t){case a.modes().WAITING:case a.modes().WAITING_REVEAL:e();break;case a.modes().REVEAL:App.reveal();break;case a.modes().ENDGAME:n.clear(),setMode(a.modes().IDLE)}}}}();const o=["RockPaperScissor"];var r=!0;return{web3Provider:null,contracts:{},address:{rps:null},events:{GameSessionCreated:null,GameKeyReveal:null,GameSessionEnded:null,CheckPoint:null,RevealValidTime:null},init:function(){return e("Initializing Web App."),App.initWeb3()},initWeb3:function(){return e("Connecting to Web3 Provider.."),HelperUtil.initWeb3(App),App.initContract()},initContract:function(){e("Retrieving Smart Contract Artifacts...");for(var t=0;t<o.length;t++)!function(t){var n=o[t];$.getJSON("/web/contracts/"+n+".json",function(a){if(e("Connection Established to: "+n),App.contracts[n]=TruffleContract(a),App.contracts[n].setProvider(App.web3Provider),e(n+" Artifact Saved."),t==o.length-1)return App.bindEvents()})}(t);return!0},callContract:function(t,n){e(t.M1),App.contracts.RockPaperScissor.deployed().then(n.call).then(function(n){return e(t.M2),n}).then(n.callback).catch(function(t){e(t.message)})},play:function(){if(n.userCanPlay()){var t={M1:"User playing game..",M2:"Received Result: "},o={call:function(e){return user=n.getUsername(),choice=n.getUserChoice(),pass=web3.sha3(n.getPassword()+choice),e.play(pass,user,{from:web3.eth.accounts[0],value:web3.toWei(n.getAmount(),"ether")})},callback:function(t){for(var n=0;n<t.logs.length;n++){switch(t.logs[n].event){case"GameKeyReveal":alert("Joined Existing Game."),a.setMode(a.modes().REVEAL);break;case"GameSessionCreated":alert("Created New Game."),a.setMode(a.modes().WAITING)}}e(t)}};App.callContract(t,o)}},reveal:function(){if(a.getMode()==a.modes().REVEAL){var o={M1:"Revealing hand..",M2:"Received Result: "},r={call:function(e){return choice=n.getUserChoice(),pass=n.getPassword(),e.reveal(pass,choice)},callback:function(n){for(var o=0;o<n.logs.length;o++){var r=n.logs[o];switch(r.event){case"GameSessionEnded":t(r.args.winner),a.setMode(a.modes().ENDGAME),e(r.event);break;case"WaitingForPlayer2":e(r.event),a.setMode(a.modes().WAITING_REVEAL)}}e(n)}};App.callContract(o,r)}},checkForPlayerJoined:function(){if(a.getMode()==a.modes().WAITING){var t={M1:"Getting Player Status",M2:"Received Result: "},n={call:function(e){return e.getPlayerStatus()},callback:function(t){e(t),3===t[1].c[0]&&a.setMode(a.modes().REVEAL)}};return App.callContract(t,n),a.getMode()!=a.modes().WAITING}return!1},checkForPlayerReveal:function(){if(a.getMode()==a.modes().WAITING_REVEAL){var e={M1:"Waiting On Player Two",M2:"Received Result: "},n={call:function(e){return e.getCurrentGameWinner()},callback:function(e){t(e[0].c[0])}};return App.callContract(e,n),a.getMode()!=a.modes().WAITING_REVEAL}return!1},bindEvents:function(){n.init(),n.attachPlayButtonClickListener(this.play);var e={M1:"Initializing event listeners..",M2:"Initialized.."},t={call:function(e){function t(e,t){console.log(t)}App.address.rps=e.address;var n=App.contracts.RockPaperScissor.at(e.address);return App.events.CheckPoint=n.CheckPoint().watch(t),App.events.GameSessionCreated=n.GameSessionCreated().watch(t),App.events.GameKeyReveal=n.GameKeyReveal().watch(t),App.events.GameSessionEnded=n.GameSessionEnded().watch(t),App.events.RevealValidTime=n.RevealValidTime().watch(t),e},callback:function(e){return e}};App.callContract(e,t)}}}();$(window).on("load",function(){App.init()});